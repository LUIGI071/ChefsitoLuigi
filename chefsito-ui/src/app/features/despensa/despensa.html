
<section class="pantry-page">
  <div class="pantry-layout">

    <aside
      class="sidebar"
      [class.open]="sidebarOpen"
    >
      <div class="sidebar-header">
        <h2>Mi perfil culinario</h2>
        <p class="sidebar-subtitle">
          Personaliza c√≥mo come Chefsito contigo üçΩÔ∏è
        </p>
      </div>

      <div class="sidebar-section">
        <h3>Tipo de dieta</h3>
        <p class="sidebar-helper">
          Esto ayuda a adaptar las recetas a tu estilo de vida.
        </p>

        <select
          [ngModel]="userProfile?.dietType || ''"
          (ngModelChange)="onDietTypeChange($event)"
        >
          <option value="">Sin preferencia</option>
          <option value="Omn√≠vora">Omn√≠vora</option>
          <option value="Vegetariana">Vegetariana</option>
          <option value="Vegana">Vegana</option>
          <option value="Sin gluten">Sin gluten</option>
          <option value="Keto">Keto</option>
        </select>

        <p class="sidebar-helper current">
          Dieta actual:
          <strong>{{ getDietLabel() }}</strong>
        </p>
      </div>

      <!-- Alergias -->
      <div class="sidebar-section">
        <h3>Alergias</h3>
        <p class="sidebar-helper">
          Chefsito evitar√° recetas que las contengan.
        </p>

        <div class="allergy-search">
          <input
            type="text"
            [(ngModel)]="allergySearchText"
            (keyup.enter)="buscarAlergia()"
            placeholder="Buscar al√©rgeno (huevo, leche, frutos secos.)"
          />
          <button
            type="button"
            class="btn small"
            (click)="buscarAlergia()"
          >
            Buscar
          </button>
        </div>

        <div
          class="allergy-results"
          *ngIf="allergySearchResults.length > 0"
        >
          <button
            type="button"
            class="chip ghost"
            *ngFor="let ing of allergySearchResults"
            (click)="agregarAlergia(ing)"
          >
            {{ getIngredientDisplayName(ing) }}
          </button>
        </div>

        <div
          class="chips-row"
          *ngIf="userProfile?.allergies?.length; else noAllergies"
        >
          <span
            class="chip"
            *ngFor="let a of userProfile?.allergies"
          >
            {{ a }}
            <button
              type="button"
              class="chip-remove"
              (click)="eliminarAlergia(a)"
            >
              √ó
            </button>
          </span>
        </div>

        <ng-template #noAllergies>
          <p class="empty-text">
            A√∫n no has a√±adido alergias.
          </p>
        </ng-template>
      </div>

      <!-- Intolerancias -->
      <div class="sidebar-section">
        <h3>Intolerancias</h3>
        <p class="sidebar-helper">
          Chefsito intentar√° evitar ingredientes que te sientan mal.
        </p>

        <div class="allergy-search">
          <input
            type="text"
            [(ngModel)]="intoleranceSearchText"
            (keyup.enter)="buscarIntolerancia()"
            placeholder="Buscar intolerancia (lactosa, gluten, fructosa‚Ä¶)"
          />
          <button
            type="button"
            class="btn small"
            (click)="buscarIntolerancia()"
          >
            Buscar
          </button>
        </div>

        <div
          class="allergy-results"
          *ngIf="intoleranceSearchResults.length > 0"
        >
          <button
            type="button"
            class="chip ghost"
            *ngFor="let ing of intoleranceSearchResults"
            (click)="agregarIntolerancia(ing)"
          >
            {{ getIngredientDisplayName(ing) }}
          </button>
        </div>

        <div
          class="chips-row"
          *ngIf="userProfile?.intolerances?.length; else noIntolerances"
        >
          <span
            class="chip"
            *ngFor="let i of userProfile?.intolerances"
          >
            {{ i }}
            <button
              type="button"
              class="chip-remove"
              (click)="eliminarIntolerancia(i)"
            >
              √ó
            </button>
          </span>
        </div>

        <ng-template #noIntolerances>
          <p class="empty-text">
            A√∫n no has a√±adido intolerancias.
          </p>
        </ng-template>
      </div>

      <!-- Ingredientes que no le gustan -->
      <div class="sidebar-section">
        <h3>Ingredientes que no me gustan</h3>
        <p class="sidebar-helper">
          Se evitar√°n en las recomendaciones de recetas.
        </p>

        <div class="disliked-input-row">
          <input
            type="text"
            [(ngModel)]="dislikedInput"
            (input)="onDislikedInputChange(dislikedInput)"
            (keyup.enter)="addDislikedIngredient()"
            placeholder="Ej: aceitunas, cilantro."
          />
          <button
            type="button"
            class="btn small"
            (click)="addDislikedIngredient()"
          >
            A√±adir
          </button>
        </div>

        <div
          class="disliked-suggestions"
          *ngIf="filteredDislikedSuggestions.length > 0"
        >
          <button
            type="button"
            class="chip ghost"
            *ngFor="let sug of filteredDislikedSuggestions"
            (click)="addDislikedIngredient(sug)"
          >
            {{ sug }}
          </button>
        </div>

        <div
          class="chips-row"
          *ngIf="userProfile?.dislikedIngredients?.length; else noDisliked"
        >
          <span
            class="chip chip-soft"
            *ngFor="let d of userProfile?.dislikedIngredients"
          >
            {{ d }}
            <button
              type="button"
              class="chip-remove"
              (click)="removeDislikedIngredient(d)"
            >
              √ó
            </button>
          </span>
        </div>

        <ng-template #noDisliked>
          <p class="empty-text">
            No has indicado ingredientes que no te gusten.
          </p>
        </ng-template>
      </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="pantry-main">
      <!-- HEADER -->
      <header class="pantry-header">
        <div class="title-block">
          <button
            type="button"
            class="hamburger-btn"
            (click)="toggleSidebar()"
          >
            ‚ò∞
          </button>

          <div class="titles">
            <h1>Tu despensa</h1>
            <p>
              Controla tus ingredientes y deja que Chefsito haga magia üë®‚Äçüç≥
            </p>
          </div>
        </div>

        <!-- Navegaci√≥n clara hacia recetas sugeridas -->
        <div class="pantry-header-actions">
          <button
            type="button"
            class="btn primary"
            routerLink="/recetas"
          >
            üçΩ Ver recetas sugeridas
          </button>
        </div>
      </header>

      <!-- BUSCADOR + VOZ -->
      <section class="pantry-search card">
        <h2>Buscar ingrediente</h2>
        <p class="search-subtitle">
          Escribe o dicta un ingrediente para a√±adirlo r√°pido a tu despensa.
        </p>

        <div class="search-row">
          <input
            type="text"
            [(ngModel)]="searchText"
            (keyup.enter)="onSearch()"
            placeholder="Tomate, arroz, pollo."
          />

          <button
            class="btn primary"
            type="button"
            (click)="onSearch()"
          >
            Buscar
          </button>

          <button
            class="btn ghost"
            type="button"
            [disabled]="!voiceSupported"
            (click)="onVoiceSearchToggle()"
          >
            <span *ngIf="!listening">Hablar üéôÔ∏è</span>
            <span *ngIf="listening">Parar ‚èπÔ∏è</span>
          </button>
        </div>

        <!-- Aviso cuando la voz no est√° disponible -->
        <p
          class="voice-warning"
          *ngIf="!voiceSupported"
        >
          La b√∫squeda por voz solo funciona en navegadores compatibles (Chrome/Edge)
          con acceso al micr√≥fono.
        </p>

        <!-- TEXTO EN VIVO DE LA VOZ -->
        <div
          class="voice-live"
          *ngIf="listening || liveTranscript"
        >
          <span class="voice-label">
            {{ listening ? 'Escuchando:' : '√öltimo dictado:' }}
          </span>
          <span class="voice-text">
            {{ liveTranscript || searchText }}
          </span>
        </div>

        <!-- ESTADO DE B√öSQUEDA -->
        <div class="search-status" *ngIf="searching">
          Buscando ingredientes‚Ä¶
        </div>

        <!-- ERROR (ej: no se pudo a√±adir a despensa) -->
        <div
          class="alert error search-alert"
          *ngIf="error"
        >
          {{ error }}
        </div>

        <!-- RESULTADOS DE B√öSQUEDA -->
        <div
          class="search-results"
          *ngIf="!searching"
        >
          <p
            *ngIf="!searchResults.length && searchText"
          >
            No se encontraron ingredientes para "{{ searchText }}".
          </p>

          <div
            class="results-grid"
            *ngIf="searchResults.length > 0"
          >
            <div
              class="ingredient-card"
              *ngFor="let ing of searchResults"
            >
              <!-- IZQUIERDA: imagen + texto -->
              <div class="search-result-main">
                <img
                  *ngIf="
                    ing.imageUrl ||
                    ing['image'] ||
                    ing['ingredientImageUrl']
                  "
                  [src]="
                    ing.imageUrl ||
                    ing['image'] ||
                    ing['ingredientImageUrl']
                  "
                  [alt]="getIngredientDisplayName(ing)"
                  class="search-result-image"
                />

                <div class="ingredient-info">
                  <h4 class="ingredient-title">
                    {{ getIngredientDisplayName(ing) }}
                  </h4>
                  <p class="ingredient-sub">
                    {{ ing.category || 'Ingrediente' }}
                  </p>
                </div>
              </div>

              <!-- DERECHA: bot√≥n -->
              <button
                type="button"
                class="btn tiny add-btn"
                (click)="addIngredientToPantry(ing)"
              >
                A√±adir a despensa
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- CONTENIDO DESPENSA -->
      <section class="pantry-content card">

        <!-- Loading -->
        <div class="loading" *ngIf="loading">
          <span class="spinner"></span>
          Cargando tus ingredientes.
        </div>

        <!-- Filtros de categor√≠a -->
        <div
          class="category-filters"
          *ngIf="!loading && alimentos.length > 0"
        >
          <span class="filter-label">Categor√≠as:</span>
          <button
            type="button"
            class="chip"
            *ngFor="let cat of availableCategories"
            [class.active]="categoryFilter === cat"
            (click)="categoryFilter = cat"
          >
            {{ cat === 'ALL' ? 'Todas' : cat }}
          </button>
        </div>

        <!-- Mensaje sin alimentos -->
        <div
          class="empty-pantry"
          *ngIf="!loading && alimentos.length === 0"
        >
          <p>Tu despensa est√° vac√≠a por ahora ü•ï</p>
          <p class="hint">
            Usa el buscador de arriba para a√±adir tus primeros ingredientes.
          </p>
        </div>

        <!-- GRID DE INGREDIENTES -->
        <div
          class="pantry-grid"
          *ngIf="!loading && getAlimentosFiltrados().length > 0"
        >
          <article
            class="pantry-card"
            *ngFor="let item of getAlimentosFiltrados()"
          >
            <!-- Imagen del ingrediente si existe, con tama√±o din√°mico -->
            <div
              class="pantry-image-wrapper"
              [ngClass]="getQuantitySizeClass(item)"
              *ngIf="item['ingredientImageUrl']"
            >
              <img
                [src]="item['ingredientImageUrl']"
                [alt]="getPantryItemDisplayName(item)"
                class="pantry-image"
              />
            </div>

            <header class="pantry-card-header">
              <h3>
                {{ getPantryItemDisplayName(item) || ('Ingrediente #' + item.ingredientId) }}
              </h3>
              <span class="pantry-category">
                {{ getCategoryForItem(item) }}
              </span>
            </header>

            <!-- Alergias detectadas -->
            <div
              class="pantry-allergy"
              *ngIf="hasAllergyForItem(item).length"
            >
              ‚ö†Ô∏è Contiene:
              <strong>{{ hasAllergyForItem(item).join(', ') }}</strong>
            </div>

            <!-- Cantidad y controles -->
            <div class="pantry-quantity">
              <span class="quantity-label">Cantidad</span>
              <div class="quantity-controls">
                <button
                  type="button"
                  class="qty-btn"
                  (click)="changeQuantity(item, -1)"
                >
                  ‚àí
                </button>
                <span class="qty-value">
                  {{ item.quantity }}
                  <span class="qty-unit" *ngIf="item['unit']">
                    {{ item['unit'] }}
                  </span>
                </span>
                <button
                  type="button"
                  class="qty-btn"
                  (click)="changeQuantity(item, +1)"
                >
                  +
                </button>
              </div>
            </div>

            <!-- Bot√≥n eliminar -->
            <div class="pantry-actions" *ngIf="confirmDeleteId !== item.id">
              <button
                type="button"
                class="btn danger tiny"
                (click)="askDelete(item)"
              >
                Eliminar
              </button>
            </div>

            <!-- Confirmaci√≥n de borrado -->
            <div
              class="confirm-dialog"
              *ngIf="confirmDeleteId === item.id"
            >
              <p>¬øSeguro que quieres eliminar este ingrediente?</p>
              <div class="confirm-buttons">
                <button
                  type="button"
                  class="btn ghost tiny"
                  (click)="cancelDelete()"
                >
                  Cancelar
                </button>
                <button
                  type="button"
                  class="btn danger tiny"
                  (click)="onDelete(item)"
                >
                  S√≠, eliminar
                </button>
              </div>
            </div>
          </article>
        </div>
      </section>
    </div>


    <div class="chef-mouse" aria-hidden="true">
      <span class="mouse">üê≠</span>
      <span class="hat">üë®‚Äçüç≥</span>
    </div>
  </div>
</section>
